=== BACKEND TEST ERROR ANALYSIS ===
Component: Backend (Node.js/TypeScript)
Task: Setup test framework and create initial test suite if missing, or fix failing tests
Context: Running 'bun run test --coverage' in backend/ directory

$ bun test --coverage
bun test v1.2.19 (aad3abea)

::group::test/status.test.ts:
(pass) Status Routes (Mock) > should have health endpoint [7.00ms]
(pass) Status Routes (Mock) > should return status information [1.00ms]
(pass) Status Routes (Mock) > should handle multiple requests

::endgroup::

::group::test/auth.test.ts:
Keycloak connection check failed: warn: Keycloak connection verification failed: Not configured
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:21:11)
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:18:47)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:15:13)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:12:19)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:56)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:63)
      at handle (/home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/src/index.ts:6609:57)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.test.ts:7:8)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.test.ts:5:35)

(pass) Auth Routes > should return auth config [13.00ms]
Keycloak connection check failed: warn: Keycloak connection verification failed: Not configured
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:21:11)
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:18:47)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:15:13)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:12:19)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:56)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:63)
      at handle (/home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/src/index.ts:6609:57)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.test.ts:19:8)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.test.ts:17:55)

(pass) Auth Routes > should handle keycloak configuration properly

::endgroup::

::group::test/index.test.ts:
(pass) Elysia Basic Tests > returns a response from root endpoint [2.00ms]
(pass) Elysia Basic Tests > returns health status
(pass) Elysia Basic Tests > handles POST requests [1.00ms]
(pass) Eden Treaty Tests > returns a response using Eden Treaty [2.00ms]
(pass) Eden Treaty Tests > handles health check with Eden Treaty [1.00ms]
(pass) Eden Treaty Tests > handles POST with Eden Treaty

::endgroup::

::group::test/auth.middleware.test.ts:

::error file=backend/test/auth.middleware.test.ts,line=24,col=24,title=error: expect(received).toBe(expected)::Expected: 401%0AReceived: 500%0A%0A      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:24:24)
19 | describe('Auth-protected route behavior', () => {
20 |   const app = createAuthApp()
21 | 
22 |   it('responds 401 when Authorization header is missing', async () => {
23 |     const res = await app.handle(new Request('http://localhost/secure', { method: 'POST' }))
24 |     expect(res.status).toBe(401)
                            ^
error: expect(received).toBe(expected)

Expected: 401
Received: 500

      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:24:24)
(fail) Auth-protected route behavior > responds 401 when Authorization header is missing [1.00ms]

::error file=backend/test/auth.middleware.test.ts,line=34,col=24,title=error: expect(received).toBe(expected)::Expected: 401%0AReceived: 500%0A%0A      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:34:24)
29 |   it('responds 401 with wrong token', async () => {
30 |     const res = await app.handle(new Request('http://localhost/secure', {
31 |       method: 'POST',
32 |       headers: { Authorization: 'Bearer wrong' }
33 |     }))
34 |     expect(res.status).toBe(401)
                            ^
error: expect(received).toBe(expected)

Expected: 401
Received: 500

      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:34:24)
(fail) Auth-protected route behavior > responds 401 with wrong token

::error file=backend/test/auth.middleware.test.ts,line=45,col=24,title=error: expect(received).toBe(expected)::Expected: 200%0AReceived: 500%0A%0A      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:45:24)
40 |     const res = await app.handle(new Request('http://localhost/secure', {
41 |       method: 'POST',
42 |       headers: { Authorization: 'Bearer secret' }
43 |     }))
44 | 
45 |     expect(res.status).toBe(200)
                            ^
error: expect(received).toBe(expected)

Expected: 200
Received: 500

      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.middleware.test.ts:45:24)
(fail) Auth-protected route behavior > accepts valid Authorization header and returns protected payload

::endgroup::

::group::test/integration.test.ts:
(pass) Integration Tests > Core Endpoints > should respond to root endpoint [2.00ms]
(pass) Integration Tests > Core Endpoints > should provide health check [1.00ms]
(pass) Integration Tests > Core Endpoints > should provide detailed status
(pass) Integration Tests > API Endpoints > should handle user listing
(pass) Integration Tests > API Endpoints > should handle user creation [1.00ms]
(pass) Integration Tests > Error Handling > should handle 404 for non-existent endpoints
(pass) Integration Tests > Error Handling > should handle malformed requests gracefully
(pass) Performance Tests > should respond to health check quickly [1.00ms]
(pass) Performance Tests > should handle multiple concurrent requests [1.00ms]

::endgroup::

::group::test/validation.test.ts:
(pass) Validation Tests > should validate required fields [3.00ms]
(pass) Validation Tests > should reject invalid email format [4.00ms]
(pass) Validation Tests > should reject missing required fields
(pass) Validation Tests > should handle optional fields
(pass) Header and Context Tests > should access headers [2.00ms]
(pass) Header and Context Tests > should derive context values
(pass) Header and Context Tests > should handle missing derived values

::endgroup::

::group::test/notfound.test.ts:
(pass) Not Found behavior > returns 404 for an unknown route [2.00ms]
(pass) Not Found behavior > returns 200 for defined route

::endgroup::

::group::test/errors.test.ts:
(pass) Error handling tests > returns 500-like status when handler throws synchronously [1.00ms]
(pass) Error handling tests > returns 500-like status when handler throws asynchronously
(pass) Error handling tests > propagates explicit Response objects from handlers [1.00ms]

::endgroup::

::group::test/auth.config.edge.test.ts:
Keycloak connection check failed: warn: Keycloak connection verification failed: Not configured
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:21:11)
      at checkKeycloakConnection (/home/runner/work/proxy-smart/proxy-smart/backend/src/init.ts:18:47)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:15:13)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/src/routes/auth/index.ts:12:19)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:56)
      at handle (file:///home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/dist/bun/index.js:6:63)
      at handle (/home/runner/work/proxy-smart/proxy-smart/node_modules/elysia/src/index.ts:6609:57)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.config.edge.test.ts:43:34)
      at <anonymous> (/home/runner/work/proxy-smart/proxy-smart/backend/test/auth.config.edge.test.ts:39:68)

(pass) Auth Config Route Edge Cases > returns isConfigured=false when Keycloak is not configured
[2025-08-17T09:08:34.394Z] [32minfo[0m [[36mkeycloak[0m] Checking Keycloak connection (attempt 1/1)...
[2025-08-17T09:08:34.395Z] [31merror[0m [[36mkeycloak[0m] Keycloak connection check failed after all retry attempts
{
  "error": "Unable to connect. Is the computer able to access the url?"
}
[2025-08-17T09:08:34.395Z] [33mwarn[0m [[36mkeycloak[0m] Some Keycloak endpoints are not accessible, but critical authentication components are working
(pass) Auth Config Route Edge Cases > returns isConfigured=true when KEYCLOAK_BASE_URL is provided and preserves JSON shape [2.00ms]

::endgroup::

::group::test/malformed-json.test.ts:
(pass) Malformed JSON handling > returns client error for malformed JSON payloads [1.00ms]
(pass) Malformed JSON handling > parses valid JSON correctly [1.00ms]

::endgroup::

3 tests failed:
(fail) Auth-protected route behavior > responds 401 when Authorization header is missing [1.00ms]
(fail) Auth-protected route behavior > responds 401 with wrong token
(fail) Auth-protected route behavior > accepts valid Authorization header and returns protected payload
--------------------------------------------------|---------|---------|-------------------
File                                              | % Funcs | % Lines | Uncovered Line #s
--------------------------------------------------|---------|---------|-------------------
All files                                         |   23.86 |   37.55 |
 src/config.ts                                    |   50.00 |   59.42 | 30-37,74-93
 src/init.ts                                      |   50.00 |   22.37 | 55-56,58,60-62,64,67-68,70-72,74-75,78-80,82-90,92-94,98,110-117,119-125,127-132,137,142,144-145,148,157-192,201-262,271-286
 src/lib/admin-utils.ts                           |    0.00 |   15.63 | 23-27,42-43,52-53,65-95,105-115,127-154,164
 src/lib/auth.ts                                  |    0.00 |    9.86 | 10-25,36-83
 src/lib/fhir-server-store.ts                     |    0.00 |   11.69 | 18-80,85,89-121,125,129,133,137,141,145,149,158-163,168-173,178-183,188-232,238-271,277-279
 src/lib/fhir-utils.ts                            |    0.00 |    7.10 | 45-73,80-143,151-155,162,169-185,193-219
 src/lib/keycloak-plugin.ts                       |    0.00 |    7.21 | 14-116
 src/lib/logger.ts                                |   25.00 |   81.22 | 145,149,222,232-235,239-245,251-270
 src/lib/oauth-metrics-logger.ts                  |    9.09 |    5.48 | 74-144,152-153,160-161,168-196,203-374
 src/routes/admin/client-registration-settings.ts |    0.00 |   58.19 | 64-89,97-120,127-141,180-195,237-252
 src/routes/auth/client-registration.ts           |    0.00 |   11.50 | 47-60,67-329
 src/routes/auth/index.ts                         |  100.00 |  100.00 | 
 src/routes/auth/oauth.ts                         |    0.00 |   36.10 | 42-79,89-100,123-145,166-204,221-253,274-432,507-513,538-573
 src/schemas/common.ts                            |  100.00 |  100.00 | 
--------------------------------------------------|---------|---------|-------------------

 36 pass
 3 fail
 81 expect() calls
Ran 39 tests across 10 files. [228.00ms]
error: script "test" exited with code 1
